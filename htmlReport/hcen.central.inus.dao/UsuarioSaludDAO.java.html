<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsuarioSaludDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">All in tests Coverage Results</a> &gt; <a href="index.source.html" class="el_package">hcen.central.inus.dao</a> &gt; <span class="el_source">UsuarioSaludDAO.java</span></div><h1>UsuarioSaludDAO.java</h1><pre class="source lang-java linenums">package hcen.central.inus.dao;

import hcen.central.inus.entity.UsuarioSalud;
import hcen.central.inus.enums.TipoDocumento;
import jakarta.ejb.Stateless;
import jakarta.persistence.EntityManager;
import jakarta.persistence.NoResultException;
import jakarta.persistence.PersistenceContext;
import jakarta.persistence.TypedQuery;

import java.util.List;
import java.util.Optional;

/**
 * DAO para operaciones CRUD sobre UsuarioSalud
 * Usado para gestión de usuarios desde clínicas periféricas
 */
@Stateless
<span class="fc" id="L19">public class UsuarioSaludDAO {</span>

    @PersistenceContext(unitName = &quot;hcen-central-pu&quot;)
    private EntityManager em;

    /**
     * Guarda o actualiza un usuario
     */
    public UsuarioSalud save(UsuarioSalud usuario) {
<span class="pc bpc" id="L28" title="1 of 2 branches missed.">        if (usuario.getId() == null) {</span>
<span class="fc" id="L29">            em.persist(usuario);</span>
<span class="fc" id="L30">            return usuario;</span>
        } else {
<span class="nc" id="L32">            return em.merge(usuario);</span>
        }
    }

    /**
     * Busca usuario por cédula
     */
    public Optional&lt;UsuarioSalud&gt; findByCedula(String cedula) {
        try {
<span class="nc" id="L41">            TypedQuery&lt;UsuarioSalud&gt; query = em.createQuery(</span>
                &quot;SELECT u FROM UsuarioSalud u WHERE u.cedula = :cedula&quot;,
                UsuarioSalud.class
            );
<span class="nc" id="L45">            query.setParameter(&quot;cedula&quot;, cedula);</span>
<span class="nc" id="L46">            return Optional.of(query.getSingleResult());</span>
<span class="nc" id="L47">        } catch (NoResultException e) {</span>
<span class="nc" id="L48">            return Optional.empty();</span>
        }
    }

    /**
     * Verifica si existe un usuario con la cédula dada
     */
    public boolean existsByCedula(String cedula) {
<span class="fc" id="L56">        TypedQuery&lt;Long&gt; query = em.createQuery(</span>
            &quot;SELECT COUNT(u) FROM UsuarioSalud u WHERE u.cedula = :cedula&quot;,
            Long.class
        );
<span class="fc" id="L60">        query.setParameter(&quot;cedula&quot;, cedula);</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">        return query.getSingleResult() &gt; 0;</span>
    }

    /**
     * Busca usuario por ID
     */
    public Optional&lt;UsuarioSalud&gt; findById(Long id) {
<span class="nc" id="L68">        UsuarioSalud usuario = em.find(UsuarioSalud.class, id);</span>
<span class="nc" id="L69">        return Optional.ofNullable(usuario);</span>
    }

    /**
     * Lista todos los usuarios activos
     */
    public List&lt;UsuarioSalud&gt; findAllActive() {
<span class="nc" id="L76">        TypedQuery&lt;UsuarioSalud&gt; query = em.createQuery(</span>
            &quot;SELECT u FROM UsuarioSalud u WHERE u.active = true ORDER BY u.primerApellido, u.primerNombre&quot;,
            UsuarioSalud.class
        );
<span class="nc" id="L80">        return query.getResultList();</span>
    }

    /**
     * Lista usuarios paginados
     */
    public List&lt;UsuarioSalud&gt; findAllPaginated(int page, int size) {
<span class="nc" id="L87">        TypedQuery&lt;UsuarioSalud&gt; query = em.createQuery(</span>
            &quot;SELECT u FROM UsuarioSalud u WHERE u.active = true ORDER BY u.primerApellido, u.primerNombre&quot;,
            UsuarioSalud.class
        );
<span class="nc" id="L91">        query.setFirstResult(page * size);</span>
<span class="nc" id="L92">        query.setMaxResults(size);</span>
<span class="nc" id="L93">        return query.getResultList();</span>
    }

    /**
     * Busca usuarios aplicando filtros opcionales
     */
    public List&lt;UsuarioSalud&gt; findByFilters(TipoDocumento tipoDocumento,
                                            String numeroDocumento,
                                            String nombre,
                                            String apellido,
                                            int page,
                                            int size) {
<span class="nc" id="L105">        StringBuilder jpql = new StringBuilder(&quot;SELECT u FROM UsuarioSalud u WHERE u.active = true&quot;);</span>

<span class="nc bnc" id="L107" title="All 6 branches missed.">        if (tipoDocumento != null &amp;&amp; numeroDocumento != null &amp;&amp; !numeroDocumento.isBlank()) {</span>
<span class="nc" id="L108">            jpql.append(&quot; AND u.tipoDeDocumento = :tipoDocumento AND u.cedula = :cedula&quot;);</span>
        } else {
<span class="nc bnc" id="L110" title="All 4 branches missed.">            if (nombre != null &amp;&amp; !nombre.isBlank()) {</span>
<span class="nc" id="L111">                jpql.append(&quot; AND LOWER(u.primerNombre) LIKE LOWER(:nombre)&quot;);</span>
            }
<span class="nc bnc" id="L113" title="All 4 branches missed.">            if (apellido != null &amp;&amp; !apellido.isBlank()) {</span>
<span class="nc" id="L114">                jpql.append(&quot; AND LOWER(u.primerApellido) LIKE LOWER(:apellido)&quot;);</span>
            }
        }

<span class="nc" id="L118">        jpql.append(&quot; ORDER BY u.primerApellido, u.primerNombre&quot;);</span>

<span class="nc" id="L120">        TypedQuery&lt;UsuarioSalud&gt; query = em.createQuery(jpql.toString(), UsuarioSalud.class);</span>

<span class="nc bnc" id="L122" title="All 6 branches missed.">        if (tipoDocumento != null &amp;&amp; numeroDocumento != null &amp;&amp; !numeroDocumento.isBlank()) {</span>
<span class="nc" id="L123">            query.setParameter(&quot;tipoDocumento&quot;, tipoDocumento);</span>
<span class="nc" id="L124">            query.setParameter(&quot;cedula&quot;, numeroDocumento.trim());</span>
        } else {
<span class="nc bnc" id="L126" title="All 4 branches missed.">            if (nombre != null &amp;&amp; !nombre.isBlank()) {</span>
<span class="nc" id="L127">                query.setParameter(&quot;nombre&quot;, &quot;%&quot; + nombre.trim() + &quot;%&quot;);</span>
            }
<span class="nc bnc" id="L129" title="All 4 branches missed.">            if (apellido != null &amp;&amp; !apellido.isBlank()) {</span>
<span class="nc" id="L130">                query.setParameter(&quot;apellido&quot;, &quot;%&quot; + apellido.trim() + &quot;%&quot;);</span>
            }
        }

<span class="nc" id="L134">        query.setFirstResult(page * size);</span>
<span class="nc" id="L135">        query.setMaxResults(size);</span>
<span class="nc" id="L136">        return query.getResultList();</span>
    }

    /**
     * Cuenta usuarios aplicando filtros
     */
    public long countByFilters(TipoDocumento tipoDocumento,
                               String numeroDocumento,
                               String nombre,
                               String apellido) {
<span class="nc" id="L146">        StringBuilder jpql = new StringBuilder(&quot;SELECT COUNT(u) FROM UsuarioSalud u WHERE u.active = true&quot;);</span>

<span class="nc bnc" id="L148" title="All 6 branches missed.">        if (tipoDocumento != null &amp;&amp; numeroDocumento != null &amp;&amp; !numeroDocumento.isBlank()) {</span>
<span class="nc" id="L149">            jpql.append(&quot; AND u.tipoDeDocumento = :tipoDocumento AND u.cedula = :cedula&quot;);</span>
        } else {
<span class="nc bnc" id="L151" title="All 4 branches missed.">            if (nombre != null &amp;&amp; !nombre.isBlank()) {</span>
<span class="nc" id="L152">                jpql.append(&quot; AND LOWER(u.primerNombre) LIKE LOWER(:nombre)&quot;);</span>
            }
<span class="nc bnc" id="L154" title="All 4 branches missed.">            if (apellido != null &amp;&amp; !apellido.isBlank()) {</span>
<span class="nc" id="L155">                jpql.append(&quot; AND LOWER(u.primerApellido) LIKE LOWER(:apellido)&quot;);</span>
            }
        }

<span class="nc" id="L159">        TypedQuery&lt;Long&gt; query = em.createQuery(jpql.toString(), Long.class);</span>

<span class="nc bnc" id="L161" title="All 6 branches missed.">        if (tipoDocumento != null &amp;&amp; numeroDocumento != null &amp;&amp; !numeroDocumento.isBlank()) {</span>
<span class="nc" id="L162">            query.setParameter(&quot;tipoDocumento&quot;, tipoDocumento);</span>
<span class="nc" id="L163">            query.setParameter(&quot;cedula&quot;, numeroDocumento.trim());</span>
        } else {
<span class="nc bnc" id="L165" title="All 4 branches missed.">            if (nombre != null &amp;&amp; !nombre.isBlank()) {</span>
<span class="nc" id="L166">                query.setParameter(&quot;nombre&quot;, &quot;%&quot; + nombre.trim() + &quot;%&quot;);</span>
            }
<span class="nc bnc" id="L168" title="All 4 branches missed.">            if (apellido != null &amp;&amp; !apellido.isBlank()) {</span>
<span class="nc" id="L169">                query.setParameter(&quot;apellido&quot;, &quot;%&quot; + apellido.trim() + &quot;%&quot;);</span>
            }
        }

<span class="nc" id="L173">        return query.getSingleResult();</span>
    }

    /**
     * Cuenta total de usuarios activos
     */
    public long countAllActive() {
<span class="nc" id="L180">        TypedQuery&lt;Long&gt; query = em.createQuery(</span>
            &quot;SELECT COUNT(u) FROM UsuarioSalud u WHERE u.active = true&quot;,
            Long.class
        );
<span class="nc" id="L184">        return query.getSingleResult();</span>
    }

    /**
     * Lista todos los usuarios de una clínica (por tenant_id)
     */
    public List&lt;UsuarioSalud&gt; findByTenantId(java.util.UUID tenantId) {
<span class="nc" id="L191">        TypedQuery&lt;UsuarioSalud&gt; query = em.createQuery(</span>
            &quot;SELECT u FROM UsuarioSalud u WHERE u.tenantId = :tenantId AND u.active = true &quot; +
            &quot;ORDER BY u.primerApellido, u.primerNombre&quot;,
            UsuarioSalud.class
        );
<span class="nc" id="L196">        query.setParameter(&quot;tenantId&quot;, normalizeTenantId(tenantId));</span>
<span class="nc" id="L197">        return query.getResultList();</span>
    }

    /**
     * Busca usuarios por nombre o apellido
     */
    public List&lt;UsuarioSalud&gt; searchByNombreOrApellido(String searchTerm) {
<span class="nc" id="L204">        TypedQuery&lt;UsuarioSalud&gt; query = em.createQuery(</span>
            &quot;SELECT u FROM UsuarioSalud u WHERE u.active = true AND (&quot; +
            &quot;LOWER(u.primerNombre) LIKE LOWER(:term) OR &quot; +
            &quot;LOWER(u.segundoNombre) LIKE LOWER(:term) OR &quot; +
            &quot;LOWER(u.primerApellido) LIKE LOWER(:term) OR &quot; +
            &quot;LOWER(u.segundoApellido) LIKE LOWER(:term)) &quot; +
            &quot;ORDER BY u.primerApellido, u.primerNombre&quot;,
            UsuarioSalud.class
        );
<span class="nc" id="L213">        query.setParameter(&quot;term&quot;, &quot;%&quot; + searchTerm + &quot;%&quot;);</span>
<span class="nc" id="L214">        return query.getResultList();</span>
    }

    /**
     * Busca usuarios por nombre o apellido filtrados por tenant_id
     */
    public List&lt;UsuarioSalud&gt; searchByNombreOrApellidoAndTenantId(String searchTerm, java.util.UUID tenantId) {
<span class="nc" id="L221">        TypedQuery&lt;UsuarioSalud&gt; query = em.createQuery(</span>
            &quot;SELECT u FROM UsuarioSalud u WHERE u.tenantId = :tenantId AND u.active = true AND (&quot; +
            &quot;LOWER(u.primerNombre) LIKE LOWER(:term) OR &quot; +
            &quot;LOWER(u.segundoNombre) LIKE LOWER(:term) OR &quot; +
            &quot;LOWER(u.primerApellido) LIKE LOWER(:term) OR &quot; +
            &quot;LOWER(u.segundoApellido) LIKE LOWER(:term)) &quot; +
            &quot;ORDER BY u.primerApellido, u.primerNombre&quot;,
            UsuarioSalud.class
        );
<span class="nc" id="L230">        query.setParameter(&quot;term&quot;, &quot;%&quot; + searchTerm + &quot;%&quot;);</span>
<span class="nc" id="L231">        query.setParameter(&quot;tenantId&quot;, normalizeTenantId(tenantId));</span>
<span class="nc" id="L232">        return query.getResultList();</span>
    }

    /**
     * Verifica si existe un usuario con la combinación cédula + tenant_id
     */
    public boolean existsByCedulaAndTenantId(String cedula, java.util.UUID tenantId) {
<span class="fc" id="L239">        TypedQuery&lt;Long&gt; query = em.createQuery(</span>
            &quot;SELECT COUNT(u) FROM UsuarioSalud u WHERE u.cedula = :cedula AND u.tenantId = :tenantId&quot;,
            Long.class
        );
<span class="fc" id="L243">        query.setParameter(&quot;cedula&quot;, cedula);</span>
<span class="fc" id="L244">        query.setParameter(&quot;tenantId&quot;, normalizeTenantId(tenantId));</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">        return query.getSingleResult() &gt; 0;</span>
    }

    /**
     * Elimina físicamente un usuario por la combinación cédula + tenant_id
     */
    public boolean deleteByCedulaAndTenantId(String cedula, java.util.UUID tenantId) {
        try {
<span class="nc" id="L253">            TypedQuery&lt;UsuarioSalud&gt; query = em.createQuery(</span>
                &quot;SELECT u FROM UsuarioSalud u WHERE u.cedula = :cedula AND u.tenantId = :tenantId&quot;,
                UsuarioSalud.class
            );
<span class="nc" id="L257">            query.setParameter(&quot;cedula&quot;, cedula);</span>
<span class="nc" id="L258">            query.setParameter(&quot;tenantId&quot;, normalizeTenantId(tenantId));</span>
<span class="nc" id="L259">            UsuarioSalud usuario = query.getSingleResult();</span>
<span class="nc" id="L260">            em.remove(usuario);</span>
<span class="nc" id="L261">            return true;</span>
<span class="nc" id="L262">        } catch (NoResultException e) {</span>
<span class="nc" id="L263">            return false;</span>
        }
    }

    /**
     * Desactiva un usuario (soft delete)
     */
    public void deactivate(String cedula) {
<span class="nc" id="L271">        Optional&lt;UsuarioSalud&gt; usuario = findByCedula(cedula);</span>
<span class="nc" id="L272">        usuario.ifPresent(u -&gt; {</span>
<span class="nc" id="L273">            u.setActive(false);</span>
<span class="nc" id="L274">            em.merge(u);</span>
<span class="nc" id="L275">        });</span>
<span class="nc" id="L276">    }</span>

    private String normalizeTenantId(java.util.UUID tenantId) {
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">        return tenantId != null ? tenantId.toString() : null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>