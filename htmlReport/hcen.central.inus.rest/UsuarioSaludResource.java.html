<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsuarioSaludResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">All in tests Coverage Results</a> &gt; <a href="index.source.html" class="el_package">hcen.central.inus.rest</a> &gt; <span class="el_source">UsuarioSaludResource.java</span></div><h1>UsuarioSaludResource.java</h1><pre class="source lang-java linenums">package hcen.central.inus.rest;

import hcen.central.inus.dto.RegistrarUsuarioRequest;
import hcen.central.inus.dto.UsuarioSaludDTO;
import hcen.central.inus.service.UsuarioSaludService;
import jakarta.ejb.EJB;
import jakarta.ws.rs.*;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;

import java.util.Map;
import java.util.Optional;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * REST Resource para gestión de usuarios de salud desde clínicas periféricas
 * Base path: /api/usuarios
 */
@Path(&quot;/usuarios&quot;)
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
<span class="nc" id="L23">public class UsuarioSaludResource {</span>

<span class="nc" id="L25">    private static final Logger LOGGER = Logger.getLogger(UsuarioSaludResource.class.getName());</span>

    @EJB
    private UsuarioSaludService usuarioService;

    /**
     * Lista todos los usuarios de una clínica
     * GET /api/usuarios?tenantId={uuid}
     */
    @GET
    public Response getUsuariosByTenantId(@QueryParam(&quot;tenantId&quot;) String tenantIdStr,
                                          @QueryParam(&quot;search&quot;) String searchTerm) {
        try {
<span class="nc bnc" id="L38" title="All 4 branches missed.">            if (tenantIdStr == null || tenantIdStr.trim().isEmpty()) {</span>
<span class="nc" id="L39">                return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L40">                    .entity(Map.of(&quot;error&quot;, &quot;El parámetro tenantId es requerido&quot;))</span>
<span class="nc" id="L41">                    .build();</span>
            }

<span class="nc" id="L44">            java.util.UUID tenantId = java.util.UUID.fromString(tenantIdStr);</span>
            java.util.List&lt;UsuarioSaludDTO&gt; usuarios;

<span class="nc bnc" id="L47" title="All 4 branches missed.">            if (searchTerm != null &amp;&amp; !searchTerm.trim().isEmpty()) {</span>
                // Búsqueda con filtro
<span class="nc" id="L49">                usuarios = usuarioService.searchUsuariosByTenantId(searchTerm, tenantId);</span>
            } else {
                // Listar todos
<span class="nc" id="L52">                usuarios = usuarioService.getUsuariosByTenantId(tenantId);</span>
            }

<span class="nc" id="L55">            return Response.ok(usuarios).build();</span>
<span class="nc" id="L56">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L57">            return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L58">                .entity(Map.of(&quot;error&quot;, e.getMessage()))</span>
<span class="nc" id="L59">                .build();</span>
<span class="nc" id="L60">        } catch (Exception e) {</span>
<span class="nc" id="L61">            LOGGER.log(Level.SEVERE, &quot;Error al obtener usuarios&quot;, e);</span>
<span class="nc" id="L62">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L63">                .entity(Map.of(&quot;error&quot;, &quot;Error interno del servidor&quot;))</span>
<span class="nc" id="L64">                .build();</span>
        }
    }

    /**
     * Verifica si un usuario existe por cédula
     * GET /api/usuarios/verificar/{cedula}
     */
    @GET
    @Path(&quot;/verificar/{cedula}&quot;)
    public Response verificarUsuarioExiste(@PathParam(&quot;cedula&quot;) String cedula) {
        try {
<span class="nc" id="L76">            boolean existe = usuarioService.verificarUsuarioExiste(cedula);</span>
<span class="nc" id="L77">            return Response.ok(Map.of(&quot;existe&quot;, existe, &quot;cedula&quot;, cedula)).build();</span>
<span class="nc" id="L78">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L79">            return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L80">                .entity(Map.of(&quot;error&quot;, e.getMessage()))</span>
<span class="nc" id="L81">                .build();</span>
<span class="nc" id="L82">        } catch (Exception e) {</span>
<span class="nc" id="L83">            LOGGER.log(Level.SEVERE, &quot;Error al verificar usuario&quot;, e);</span>
<span class="nc" id="L84">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L85">                .entity(Map.of(&quot;error&quot;, &quot;Error interno del servidor&quot;))</span>
<span class="nc" id="L86">                .build();</span>
        }
    }

    /**
     * Registra un usuario en una clínica
     * Si el usuario existe, actualiza sus datos y crea la asociación
     * Si no existe, lo crea y crea la asociación
     * POST /api/usuarios/registrar
     */
    @POST
    @Path(&quot;/registrar&quot;)
    public Response registrarUsuario(RegistrarUsuarioRequest request) {
        try {
<span class="nc" id="L100">            LOGGER.info(&quot;Recibida solicitud de registro: &quot; + request);</span>
<span class="nc" id="L101">            UsuarioSaludDTO usuarioDTO = usuarioService.registrarUsuarioEnClinica(request);</span>
<span class="nc" id="L102">            return Response.ok(usuarioDTO).build();</span>
<span class="nc" id="L103">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L104">            LOGGER.warning(&quot;Validación fallida: &quot; + e.getMessage());</span>
<span class="nc" id="L105">            return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L106">                .entity(Map.of(&quot;error&quot;, e.getMessage()))</span>
<span class="nc" id="L107">                .build();</span>
<span class="nc" id="L108">        } catch (Exception e) {</span>
<span class="nc" id="L109">            LOGGER.log(Level.SEVERE, &quot;Error al registrar usuario&quot;, e);</span>
<span class="nc" id="L110">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L111">                .entity(Map.of(&quot;error&quot;, &quot;Error interno del servidor: &quot; + e.getMessage()))</span>
<span class="nc" id="L112">                .build();</span>
        }
    }

    /**
     * Obtiene datos de un usuario por cédula
     * GET /api/usuarios/{cedula}
     */
    @GET
    @Path(&quot;/{cedula}&quot;)
    public Response getUsuarioByCedula(@PathParam(&quot;cedula&quot;) String cedula) {
        try {
<span class="nc" id="L124">            Optional&lt;UsuarioSaludDTO&gt; usuario = usuarioService.getUsuarioByCedula(cedula);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (usuario.isPresent()) {</span>
<span class="nc" id="L126">                return Response.ok(usuario.get()).build();</span>
            } else {
<span class="nc" id="L128">                return Response.status(Response.Status.NOT_FOUND)</span>
<span class="nc" id="L129">                    .entity(Map.of(&quot;error&quot;, &quot;Usuario no encontrado&quot;, &quot;cedula&quot;, cedula))</span>
<span class="nc" id="L130">                    .build();</span>
            }
<span class="nc" id="L132">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L133">            return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L134">                .entity(Map.of(&quot;error&quot;, e.getMessage()))</span>
<span class="nc" id="L135">                .build();</span>
<span class="nc" id="L136">        } catch (Exception e) {</span>
<span class="nc" id="L137">            LOGGER.log(Level.SEVERE, &quot;Error al obtener usuario&quot;, e);</span>
<span class="nc" id="L138">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L139">                .entity(Map.of(&quot;error&quot;, &quot;Error interno del servidor&quot;))</span>
<span class="nc" id="L140">                .build();</span>
        }
    }

    /**
     * Desasocia un usuario de una clínica (elimina el registro con esa combinación cedula+tenant_id)
     * DELETE /api/usuarios/{cedula}/clinica/{tenantId}
     */
    @DELETE
    @Path(&quot;/{cedula}/clinica/{tenantId}&quot;)
    public Response desasociarUsuarioDeClinica(@PathParam(&quot;cedula&quot;) String cedula,
                                               @PathParam(&quot;tenantId&quot;) String tenantIdStr) {
        try {
<span class="nc" id="L153">            java.util.UUID tenantId = java.util.UUID.fromString(tenantIdStr);</span>
<span class="nc" id="L154">            boolean deleted = usuarioService.desasociarUsuarioDeClinica(cedula, tenantId);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (deleted) {</span>
<span class="nc" id="L156">                return Response.ok(Map.of(&quot;message&quot;, &quot;Usuario desasociado de la clínica exitosamente&quot;)).build();</span>
            } else {
<span class="nc" id="L158">                return Response.status(Response.Status.NOT_FOUND)</span>
<span class="nc" id="L159">                    .entity(Map.of(&quot;error&quot;, &quot;No se encontró el usuario en esa clínica&quot;))</span>
<span class="nc" id="L160">                    .build();</span>
            }
<span class="nc" id="L162">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L163">            return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L164">                .entity(Map.of(&quot;error&quot;, e.getMessage()))</span>
<span class="nc" id="L165">                .build();</span>
<span class="nc" id="L166">        } catch (Exception e) {</span>
<span class="nc" id="L167">            LOGGER.log(Level.SEVERE, &quot;Error al desasociar usuario de clínica&quot;, e);</span>
<span class="nc" id="L168">            return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L169">                .entity(Map.of(&quot;error&quot;, &quot;Error interno del servidor: &quot; + e.getMessage()))</span>
<span class="nc" id="L170">                .build();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>