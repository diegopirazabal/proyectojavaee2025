<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <f:metadata>
        <f:event type="preRenderView" listener="#{login_bean.checkAuthentication}"/>
    </f:metadata>
    <title>HCEN - Reportes y Estadísticas</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" type="text/css" href="#{request.contextPath}/resources/css/dashboard.css"/>
</h:head>

<h:body>

    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header full-bleed">
            <div class="header-content">
                <div class="logo-section">
                    <h:link outcome="dashboard?faces-redirect=true" styleClass="logo-link">
                        <h1>HCEN</h1>
                        <span>Portal Administrativo</span>
                    </h:link>
                </div>

                <div class="nav-actions">
                    <h:form id="navbarActionsForm" styleClass="nav-actions-form">
                        <p:commandButton value="Volver al Dashboard"
                                         styleClass="nav-action-button"
                                         icon="pi pi-home"
                                         action="dashboard?faces-redirect=true"
                                         ajax="false"
                                         process="@this"/>
                        <p:commandButton value="Enviar Notificación de Prueba"
                                         styleClass="nav-action-button"
                                         icon="pi pi-bell"
                                         action="#{notification_bean.sendTestNotification}"
                                         update=":reportsForm:messages"
                                         process="@this"/>
                        <p:commandButton type="button"
                                         value="Crear Clínica"
                                         styleClass="nav-action-button"
                                         icon="pi pi-building"
                                         onclick="PF('altaClinicaDialog').show()"/>
                        <p:commandButton value="Ver Reportes"
                                         styleClass="nav-action-button"
                                         icon="pi pi-chart-bar"
                                         action="reportes?faces-redirect=true"
                                         ajax="false"
                                         process="@this"/>
                    </h:form>
                </div>

                <div class="user-section">
                    <p:outputPanel rendered="#{login_bean.loggedIn}">
                        <span class="welcome-text">Bienvenido, #{login_bean.loggedAdmin.fullName}</span>
                        <h:form style="display: inline;">
                            <p:commandButton value="Cerrar Sesión"
                                             action="#{login_bean.logout}"
                                             styleClass="logout-button"
                                             icon="pi pi-sign-out"/>
                        </h:form>
                    </p:outputPanel>
                </div>
            </div>
        </header>

        <main class="dashboard-main full-bleed">
            <div class="dashboard-content full-bleed">

                <h:form id="reportsForm">
                    <p:messages id="messages" showDetail="true" closable="true"/>

                    <div class="reportes-toolbar">
                        <div class="toolbar-info">
                            <span class="last-update-label">Última actualización:</span>
                            <span class="last-update-value">#{reportes_bean.generatedAtFormatted}</span>
                        </div>
                        <div class="toolbar-actions">
                            <p:commandButton value="Actualizar datos"
                                             icon="pi pi-refresh"
                                             actionListener="#{reportes_bean.refrescarDatos}"
                                             update="reportsForm"
                                             styleClass="action-button"/>
                        </div>
                    </div>

                    <div class="metrics-grid reports-metrics">
                        <div class="metric-card">
                            <span class="metric-label">Pacientes integrados</span>
                            <span class="metric-value">#{reportes_bean.totales.pacientes}</span>
                            <span class="metric-subtext">Total nacional</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-label">Documentos clínicos</span>
                            <span class="metric-value">#{reportes_bean.totales.documentos}</span>
                            <span class="metric-subtext">Sincronizados en el RNDC</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-label">Accesos aprobados</span>
                            <span class="metric-value">#{reportes_bean.totales.accesosDocumentos}</span>
                            <span class="metric-subtext">Permisos otorgados por pacientes</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-label">Profesionales</span>
                            <span class="metric-value">#{reportes_bean.totales.profesionales}</span>
                            <span class="metric-subtext">En clínicas integradas</span>
                        </div>
                    </div>

                    <div class="dashboard-card full-width">
                        <div class="card-header">
                            <h3><i class="pi pi-briefcase"></i>Detalle por Clínica</h3>
                            <span class="card-hint">
                                #{reportes_bean.estadisticas != null ? reportes_bean.estadisticas.totalClinicas : 0} clínicas reportando
                            </span>
                        </div>
                        <div class="card-content reports-table">
                            <p:dataTable id="clinicasEstadisticas"
                                         value="#{reportes_bean.clinicasLazyModel}"
                                         var="clinica"
                                         lazy="true"
                                         paginator="true"
                                         rows="10"
                                         paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}"
                                         currentPageReportTemplate="Mostrando {startRecord}-{endRecord} de {totalRecords} clínicas"
                                         responsiveLayout="scroll"
                                         emptyMessage="No hay datos disponibles para las clínicas registradas.">
                                <p:column headerText="Clínica" sortBy="#{clinica.nombre}">
                                    <h:outputText value="#{clinica.nombre}"/>
                                    <div class="clinic-meta">
                                        <h:outputText value="#{clinica.email}" rendered="#{not empty clinica.email}"/>
                                    </div>
                                </p:column>
                                <p:column headerText="Tenant" sortBy="#{clinica.tenantId}">
                                    <code>#{clinica.tenantId}</code>
                                </p:column>
                                <p:column headerText="Pacientes" sortBy="#{clinica.pacientes}">
                                    <h:outputText value="#{clinica.pacientes}"/>
                                </p:column>
                                <p:column headerText="Documentos" sortBy="#{clinica.documentos}">
                                    <h:outputText value="#{clinica.documentos}"/>
                                </p:column>
                                <p:column headerText="Accesos aprobados" sortBy="#{clinica.accesosDocumentos}">
                                    <h:outputText value="#{clinica.accesosDocumentos}"/>
                                </p:column>
                                <p:column headerText="Profesionales" sortBy="#{clinica.profesionales}">
                                    <h:outputText value="#{clinica.profesionales}"/>
                                </p:column>
                            </p:dataTable>
                        </div>
                    </div>

                </h:form>

            </div>
        </main>

        <!-- Dialogo Alta Clínica -->
        <p:dialog id="altaClinicaDialog"
                  widgetVar="altaClinicaDialog"
                  header="Crear Clínica"
                  modal="true"
                  closable="true"
                  resizable="false"
                  styleClass="modern-dialog">
            <h:form id="altaClinicaForm" styleClass="modern-dialog-form">
                <div class="modern-form-grid">
                    <div class="modern-form-field">
                        <h:outputLabel for="nombreClinica" value="Nombre" styleClass="modern-label"/>
                        <p:inputText id="nombreClinica"
                                     value="#{dashboard_bean.nuevaClinica.nombre}"
                                     required="true"
                                     requiredMessage="El nombre es obligatorio."
                                     styleClass="modern-input"/>
                    </div>

                    <div class="modern-form-field">
                        <h:outputLabel for="emailClinica" value="Email" styleClass="modern-label"/>
                        <p:inputText id="emailClinica"
                                     value="#{dashboard_bean.nuevaClinica.email}"
                                     styleClass="modern-input"/>
                    </div>

                    <div class="modern-form-field">
                        <h:outputLabel for="direccionClinica" value="Dirección" styleClass="modern-label"/>
                        <p:inputTextarea id="direccionClinica"
                                         value="#{dashboard_bean.nuevaClinica.direccion}"
                                         autoResize="true"
                                         rows="2"
                                         styleClass="modern-input"/>
                    </div>
                </div>
                <div class="modern-dialog-footer">
                    <p:commandButton value="Crear Clínica"
                                     icon="pi pi-check"
                                     styleClass="primary-cta"
                                     action="#{dashboard_bean.crearClinica}"
                                     update=":reportsForm:messages altaClinicaDialog"
                                     process="@form"
                                     oncomplete="if (!args.validationFailed &amp;&amp; args.clinicaCreada) { PF('altaClinicaDialog').hide(); }"/>
                    <p:commandButton type="button"
                                     value="Cancelar"
                                     icon="pi pi-times"
                                     styleClass="ghost-button"
                                     onclick="PF('altaClinicaDialog').hide()"/>
                </div>
            </h:form>
        </p:dialog>

        <footer class="dashboard-footer">
            <p>© 2025 HCEN - Historia Clínica Electrónica Nacional - Universidad de la República</p>
        </footer>
    </div>

</h:body>
</html>
