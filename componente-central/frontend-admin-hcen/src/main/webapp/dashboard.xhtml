<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <title>HCEN - Dashboard Administrativo</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" type="text/css" href="#{request.contextPath}/resources/css/dashboard.css"/>
</h:head>

<h:body>
    <f:view>
        <f:metadata>
            <f:event type="preRenderView" listener="#{login_bean.checkAuthentication}"/>
        </f:metadata>
    </f:view>

    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>HCEN</h1>
                    <span>Portal Administrativo</span>
                </div>

                <div class="user-section">
                    <p:outputPanel rendered="#{login_bean.loggedIn}">
                        <span class="welcome-text">Bienvenido, #{login_bean.loggedAdmin.fullName}</span>
                        <h:form style="display: inline;">
                            <p:commandButton value="Cerrar Sesión"
                                           action="#{login_bean.logout}"
                                           styleClass="logout-button"
                                           icon="pi pi-sign-out"/>
                        </h:form>
                    </p:outputPanel>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <div class="dashboard-content">

                <h:form id="dashboardForm">
                    <p:messages id="messages" showDetail="true" closable="true"/>

                    <!-- Dashboard Cards -->
                    <div class="dashboard-grid">

                        <!-- Admin Info Card -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="pi pi-user"></i> Información del Administrador</h3>
                            </div>
                            <div class="card-content">
                                <p><strong>Usuario:</strong> #{login_bean.loggedAdmin.username}</p>
                                <p><strong>Nombre:</strong> #{login_bean.loggedAdmin.fullName}</p>
                                <p><strong>Email:</strong> #{login_bean.loggedAdmin.email}</p>
                                <p><strong>Estado:</strong>
                                    <span class="status-active">#{login_bean.loggedAdmin.active ? 'Activo' : 'Inactivo'}</span>
                                </p>
                                <p><strong>Último acceso:</strong>
                                    <h:outputText value="#{login_bean.lastLoginDisplay}"/>
                                </p>
                            </div>
                        </div>

                        <!-- System Status Card -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="pi pi-cog"></i> Estado del Sistema</h3>
                            </div>
                            <div class="card-content">
                                <p><strong>INUS:</strong> <span class="status-active">Operativo</span></p>
                                <p><strong>RNDC:</strong> <span class="status-active">Operativo</span></p>
                                <p><strong>Base de Datos:</strong> <span class="status-active">Conectada</span></p>
                                <p><strong>Servicios Web:</strong> <span class="status-active">Disponibles</span></p>
                            </div>
                        </div>

                        <!-- Quick Actions Card -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="pi pi-bolt"></i> Acciones Rápidas</h3>
                            </div>
                            <div class="card-content">
                                <p:commandButton value="Enviar Notificación de Prueba"
                                               styleClass="action-button"
                                               icon="pi pi-bell"
                                               action="#{notification_bean.sendTestNotification}"
                                               update="messages"
                                               process="@this"/>
                                <br/><br/>
                                <p:commandButton value="Gestionar Clínicas"
                                               styleClass="action-button"
                                               icon="pi pi-building"/>
                                <br/><br/>
                                <p:commandButton value="Ver Reportes"
                                               styleClass="action-button"
                                               icon="pi pi-chart-bar"/>
                                <br/><br/>
                                <p:commandButton value="Configuración"
                                               styleClass="action-button"
                                               icon="pi pi-cog"/>
                            </div>
                        </div>

                        <!-- Statistics Card -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h3><i class="pi pi-chart-line"></i> Estadísticas</h3>
                            </div>
                            <div class="card-content">
                                <p><strong>Usuarios INUS:</strong> 1,250</p>
                                <p><strong>Documentos RNDC:</strong> 5,680</p>
                                <p><strong>Clínicas Registradas:</strong> 23</p>
                                <p><strong>Accesos Hoy:</strong> 145</p>
                            </div>
                        </div>

                        <!-- Usuarios de Salud -->
                        <div class="dashboard-card full-width">
                            <div class="card-header">
                                <h3><i class="pi pi-users"></i> Usuarios de Salud</h3>
                                <div class="card-actions">
                                    <p:commandButton value="Refrescar"
                                                     icon="pi pi-refresh"
                                                     action="#{dashboard_bean.cargarUsuariosSalud}"
                                                     update="usuariosTable messages"
                                                     process="@this"
                                                     styleClass="action-button"/>
                                </div>
                            </div>
                            <div class="card-content">
                                <p:dataTable id="usuariosTable"
                                             value="#{dashboard_bean.usuariosSalud}"
                                             var="usuario"
                                             paginator="true"
                                             rows="5"
                                             emptyMessage="No hay usuarios de salud registrados."
                                             responsiveLayout="scroll">
                                    <p:column headerText="Cédula">
                                        <h:outputText value="#{usuario.cedula}"/>
                                    </p:column>
                                    <p:column headerText="Nombre">
                                        <h:outputText value="#{usuario.displayName}"/>
                                    </p:column>
                                    <p:column headerText="Email">
                                        <h:outputText value="#{usuario.email}"/>
                                    </p:column>
                                    <p:column headerText="Estado">
                                        <span class="#{usuario.active ? 'status-active' : 'status-inactive'}">
                                            #{usuario.active ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </p:column>
                                    <p:column headerText="Acciones" style="width:140px;">
                                        <p:commandButton value="Notificar"
                                                         icon="pi pi-bell"
                                                         action="#{dashboard_bean.enviarNotificacion(usuario)}"
                                                         update="messages"
                                                         process="@this"
                                                         styleClass="action-button"/>
                                    </p:column>
                                </p:dataTable>
                            </div>
                        </div>

                        <!-- Prestadores -->
                        <div class="dashboard-card full-width">
                            <div class="card-header">
                                <h3><i class="pi pi-building"></i> Prestadores (Tenants)</h3>
                                <div class="card-actions">
                                    <p:commandButton value="Refrescar"
                                                     icon="pi pi-refresh"
                                                     action="#{dashboard_bean.cargarPrestadores}"
                                                     update="prestadoresTable messages"
                                                     process="@this"
                                                     styleClass="action-button"/>
                                    <p:commandButton type="button"
                                                     value="Agregar Prestador"
                                                     icon="pi pi-plus"
                                                     onclick="PF('altaPrestadorDialog').show()"
                                                     styleClass="action-button"/>
                                </div>
                            </div>
                            <div class="card-content">
                                <p:dataTable id="prestadoresTable"
                                             value="#{dashboard_bean.prestadores}"
                                             var="prestador"
                                             paginator="true"
                                             rows="5"
                                             emptyMessage="No hay prestadores registrados."
                                             responsiveLayout="scroll">
                                    <p:column headerText="RUT">
                                        <h:outputText value="#{prestador.rut}"/>
                                    </p:column>
                                    <p:column headerText="Nombre">
                                        <h:outputText value="#{prestador.nombre}"/>
                                    </p:column>
                                    <p:column headerText="Email">
                                        <h:outputText value="#{prestador.email}"/>
                                    </p:column>
                                    <p:column headerText="Estado">
                                        <h:outputText value="#{prestador.estado}"/>
                                    </p:column>
                                    <p:column headerText="Tenant ID">
                                        <h:outputText value="#{prestador.tenantId}"/>
                                    </p:column>
                                </p:dataTable>
                            </div>
                        </div>

                    </div>

                    <!-- Dialogo Alta Prestador -->
                    <p:dialog id="altaPrestadorDialog"
                              widgetVar="altaPrestadorDialog"
                              header="Alta de Prestador"
                              modal="true"
                              closable="true"
                              resizable="false">
                        <h:panelGrid columns="2" columnClasses="label,value" styleClass="form-grid">
                            <h:outputLabel for="rut" value="RUT"/>
                            <p:inputText id="rut"
                                         value="#{dashboard_bean.nuevoPrestador.rut}"
                                         required="true"
                                         requiredMessage="El RUT es obligatorio."/>

                            <h:outputLabel for="nombrePrestador" value="Nombre"/>
                            <p:inputText id="nombrePrestador"
                                         value="#{dashboard_bean.nuevoPrestador.nombre}"
                                         required="true"
                                         requiredMessage="El nombre es obligatorio."/>

                            <h:outputLabel for="emailPrestador" value="Email"/>
                            <p:inputText id="emailPrestador"
                                         value="#{dashboard_bean.nuevoPrestador.email}"/>
                        </h:panelGrid>
                        <f:facet name="footer">
                            <p:commandButton value="Crear"
                                             icon="pi pi-check"
                                             action="#{dashboard_bean.crearPrestador}"
                                             update="messages prestadoresTable altaPrestadorDialog"
                                             process="@form"
                                            oncomplete="if (!args.validationFailed &amp;&amp; args.prestadorCreado) { PF('altaPrestadorDialog').hide(); }"/>
                            <p:commandButton type="button"
                                             value="Cancelar"
                                             icon="pi pi-times"
                                             onclick="PF('altaPrestadorDialog').hide()"/>
                        </f:facet>
                    </p:dialog>
                </h:form>

            </div>
        </main>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <p>© 2025 HCEN - Historia Clínica Electrónica Nacional - Universidad de la República</p>
        </footer>

    </div>

</h:body>
</html>
