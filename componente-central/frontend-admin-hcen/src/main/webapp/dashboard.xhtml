<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
    <title>HCEN - Dashboard Administrativo</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" type="text/css" href="#{request.contextPath}/resources/css/dashboard.css"/>
</h:head>

<h:body>
    <f:view>
        <f:metadata>
            <f:event type="preRenderView" listener="#{login_bean.checkAuthentication}"/>
        </f:metadata>
    </f:view>

    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header full-bleed">
            <div class="header-content">
                <div class="logo-section">
                    <h1>HCEN</h1>
                    <span>Portal Administrativo</span>
                </div>

                <div class="nav-actions">
                    <h:form id="navbarActionsForm" styleClass="nav-actions-form">
                        <p:commandButton value="Enviar Notificación de Prueba"
                                         styleClass="nav-action-button"
                                         icon="pi pi-bell"
                                         action="#{notification_bean.sendTestNotification}"
                                         update=":dashboardForm:messages"
                                         process="@this"/>
                        <p:commandButton type="button"
                                         value="Crear Clínica"
                                         styleClass="nav-action-button"
                                         icon="pi pi-building"
                                         onclick="PF('altaClinicaDialog').show()"/>
                        <p:commandButton value="Ver Reportes"
                                         styleClass="nav-action-button"
                                         icon="pi pi-chart-bar"
                                         action="reportes?faces-redirect=true"
                                         ajax="false"
                                         process="@this"/>
                        <p:commandButton type="button"
                                         value="Configuración"
                                         styleClass="nav-action-button"
                                         icon="pi pi-cog"/>
                    </h:form>
                </div>

                <div class="user-section">
                    <p:outputPanel rendered="#{login_bean.loggedIn}">
                        <span class="welcome-text">Bienvenido, #{login_bean.loggedAdmin.fullName}</span>
                        <h:form style="display: inline;">
                            <p:commandButton value="Cerrar Sesión"
                                           action="#{login_bean.logout}"
                                           styleClass="logout-button"
                                           icon="pi pi-sign-out"/>
                        </h:form>
                    </p:outputPanel>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main full-bleed">
            <div class="dashboard-content full-bleed">

                <h:form id="dashboardForm">
                    <p:messages id="messages" showDetail="true" closable="true"/>

                    <!-- Dashboard Cards -->
                    <div class="dashboard-grid">

                        <!-- Usuarios de Salud -->
                        <div class="dashboard-card full-width">
                            <div class="card-header">
                                <h3><i class="pi pi-users"></i> Usuarios de Salud</h3>
                                <div class="card-actions">
                                    <p:commandButton value="Refrescar"
                                                     icon="pi pi-refresh"
                                                     action="#{dashboard_bean.cargarUsuariosSalud}"
                                                     update="dashboardForm:usuariosTable dashboardForm:messages"
                                                     process="@this"
                                                     styleClass="action-button"/>
                                </div>
                            </div>
                            <div class="card-content">
                                <p:dataTable id="usuariosTable"
                                             value="#{dashboard_bean.usuariosSalud}"
                                             var="usuario"
                                             paginator="true"
                                             rows="5"
                                             emptyMessage="No hay usuarios de salud registrados."
                                             responsiveLayout="scroll">
                                    <p:column headerText="Cédula">
                                        <h:outputText value="#{usuario.cedula}"/>
                                    </p:column>
                                    <p:column headerText="Nombre">
                                        <h:outputText value="#{usuario.displayName}"/>
                                    </p:column>
                                    <p:column headerText="Email">
                                        <h:outputText value="#{usuario.email}"/>
                                    </p:column>
                                    <p:column headerText="Estado">
                                        <span class="#{usuario.active ? 'status-active' : 'status-inactive'}">
                                            #{usuario.active ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </p:column>
                                    <p:column headerText="Acciones" style="width:140px;">
                                        <p:commandButton value="Notificar"
                                                         icon="pi pi-bell"
                                                         action="#{dashboard_bean.enviarNotificacion(usuario)}"
                                                         update="dashboardForm:messages"
                                                         process="@this"
                                                         styleClass="action-button"/>
                                    </p:column>
                                </p:dataTable>
                            </div>
                        </div>

                        <!-- Clínicas -->
                        <div class="dashboard-card full-width">
                            <div class="card-header">
                                <h3><i class="pi pi-hospital"></i> Clínicas Registradas</h3>
                                <div class="card-actions">
                                    <p:commandButton value="Refrescar"
                                                     icon="pi pi-refresh"
                                                     action="#{dashboard_bean.cargarClinicas}"
                                                     update="dashboardForm:clinicasTable dashboardForm:messages"
                                                     process="@this"
                                                     styleClass="action-button"/>
                                    <p:commandButton type="button"
                                                     value="Agregar Clínica"
                                                     icon="pi pi-plus"
                                                     onclick="PF('altaClinicaDialog').show()"
                                                     styleClass="action-button"/>
                                </div>
                            </div>
                            <div class="card-content">
                                <p:dataTable id="clinicasTable"
                                             value="#{dashboard_bean.clinicas}"
                                             var="clinica"
                                             paginator="true"
                                             rows="5"
                                             emptyMessage="No hay clínicas registradas."
                                             responsiveLayout="scroll">
                                    <p:column headerText="Nombre">
                                        <h:outputText value="#{clinica.nombre}"/>
                                    </p:column>
                                    <p:column headerText="Email">
                                        <h:outputText value="#{clinica.email}"/>
                                    </p:column>
                                    <p:column headerText="Dirección">
                                        <h:outputText value="#{clinica.direccion}"/>
                                    </p:column>
                                    <p:column headerText="Estado">
                                        <h:outputText value="#{clinica.estado}"/>
                                    </p:column>
                                    <p:column headerText="Tenant ID">
                                        <h:outputText value="#{clinica.tenantId}"/>
                                    </p:column>
                                    <p:column headerText="Registrada">
                                        <h:outputText value="#{clinica.fecRegistroFormatted}"/>
                                    </p:column>
                                </p:dataTable>
                            </div>
                        </div>

                    </div>

                    <!-- Dialogo Alta Prestador -->
                    <p:dialog id="altaPrestadorDialog"
                              widgetVar="altaPrestadorDialog"
                              header="Alta de Prestador"
                              modal="true"
                              closable="true"
                              resizable="false">
                        <h:form id="altaPrestadorForm">
                            <h:panelGrid columns="2" columnClasses="label,value" styleClass="form-grid">
                                <h:outputLabel for="rut" value="RUT"/>
                                <p:inputText id="rut"
                                             value="#{dashboard_bean.nuevoPrestador.rut}"
                                             required="true"
                                             requiredMessage="El RUT es obligatorio."/>

                                <h:outputLabel for="nombrePrestador" value="Nombre"/>
                                <p:inputText id="nombrePrestador"
                                             value="#{dashboard_bean.nuevoPrestador.nombre}"
                                             required="true"
                                             requiredMessage="El nombre es obligatorio."/>

                                <h:outputLabel for="emailPrestador" value="Email"/>
                                <p:inputText id="emailPrestador"
                                             value="#{dashboard_bean.nuevoPrestador.email}"/>
                            </h:panelGrid>
                            <div class="dialog-footer" style="display:flex; justify-content:flex-end; gap:0.5rem; margin-top:1rem;">
                                <p:commandButton value="Crear"
                                                 icon="pi pi-check"
                                                 styleClass="action-button"
                                                 action="#{dashboard_bean.crearPrestador}"
                                                 update="dashboardForm:messages dashboardForm:altaPrestadorDialog"
                                                 process="@form"
                                                 oncomplete="if (!args.validationFailed &amp;&amp; args.prestadorCreado) { PF('altaPrestadorDialog').hide(); }"/>
                                <p:commandButton type="button"
                                                 value="Cancelar"
                                                 icon="pi pi-times"
                                                 styleClass="action-button"
                                                 onclick="PF('altaPrestadorDialog').hide()"/>
                            </div>
                        </h:form>
                    </p:dialog>

                    <!-- Dialogo Alta Clínica -->
                    <p:dialog id="altaClinicaDialog"
                              widgetVar="altaClinicaDialog"
                              header="Crear Clínica"
                              modal="true"
                              closable="true"
                              resizable="false"
                              styleClass="modern-dialog">
                        <h:form id="altaClinicaForm" styleClass="modern-dialog-form">
                            <div class="modern-form-grid">
                                <div class="modern-form-field">
                                    <h:outputLabel for="nombreClinica" value="Nombre" styleClass="modern-label"/>
                                    <p:inputText id="nombreClinica"
                                                 value="#{dashboard_bean.nuevaClinica.nombre}"
                                                 required="true"
                                                 requiredMessage="El nombre es obligatorio."
                                                 styleClass="modern-input"/>
                                </div>

                                <div class="modern-form-field">
                                    <h:outputLabel for="emailClinica" value="Email" styleClass="modern-label"/>
                                    <p:inputText id="emailClinica"
                                                 value="#{dashboard_bean.nuevaClinica.email}"
                                                 styleClass="modern-input"/>
                                </div>

                                <div class="modern-form-field">
                                    <h:outputLabel for="direccionClinica" value="Dirección" styleClass="modern-label"/>
                                    <p:inputTextarea id="direccionClinica"
                                                     value="#{dashboard_bean.nuevaClinica.direccion}"
                                                     autoResize="true"
                                                     rows="2"
                                                     styleClass="modern-input"/>
                                </div>
                            </div>
                            <div class="modern-dialog-footer">
                                <p:commandButton value="Crear Clínica"
                                                 icon="pi pi-check"
                                                 styleClass="primary-cta"
                                                 action="#{dashboard_bean.crearClinica}"
                                                 update="dashboardForm:messages dashboardForm:clinicasTable dashboardForm:altaClinicaDialog"
                                                 process="@form"
                                                 oncomplete="if (!args.validationFailed &amp;&amp; args.clinicaCreada) { PF('altaClinicaDialog').hide(); }"/>
                                <p:commandButton type="button"
                                                 value="Cancelar"
                                                 icon="pi pi-times"
                                                 styleClass="ghost-button"
                                                 onclick="PF('altaClinicaDialog').hide()"/>
                            </div>
                        </h:form>
                    </p:dialog>
                </h:form>

            </div>
        </main>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <p>© 2025 HCEN - Historia Clínica Electrónica Nacional - Universidad de la República</p>
        </footer>

    </div>

</h:body>
</html>
